<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribuci√≥n Personalizada de Combustible</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .control-panel {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .control-title {
            font-size: 1.8em;
            color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .btn-clear {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        .input-group {
            margin: 20px 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        input[type="number"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.2em;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .trucks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .truck-card {
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .truck-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .truck-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .truck-checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            cursor: pointer;
        }

        .truck-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .truck-id {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
        }

        .truck-plate {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .truck-info {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            color: #555;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
            transition: width 0.5s ease;
        }

        .fuel-low {
            background: linear-gradient(90deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        .fuel-medium {
            background: linear-gradient(90deg, #f9ca24 0%, #f0932b 100%);
        }

        .fuel-high {
            background: linear-gradient(90deg, #00d2ff 0%, #3a7bd5 100%);
        }

        .fuel-full {
            background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: bold;
            margin-top: 10px;
        }

        .badge-available {
            background: #00C851;
            color: white;
        }

        .badge-transit {
            background: #33b5e5;
            color: white;
        }

        .badge-maintenance {
            background: #ff4444;
            color: white;
        }

        .selection-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .summary-item {
            text-align: center;
        }

        .summary-value {
            font-size: 2.5em;
            font-weight: bold;
        }

        .summary-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .results {
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            display: none;
        }

        .results.show {
            display: block;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #667eea;
        }

        .error-message {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .success-message {
            background: #00C851;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
        }

        .no-trucks {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.2em;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .filter-btn:hover {
            background: #667eea;
            color: white;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöõ Distribuci√≥n Personalizada de Combustible</h1>
        <p class="subtitle">Selecciona los camiones y especifica el combustible disponible</p>

        <!-- Panel de Control -->
        <div class="control-panel">
            <div class="control-header">
                <div class="control-title">‚öôÔ∏è Configuraci√≥n</div>
                <button class="btn" onclick="cargarCamiones()">üîÑ Actualizar Camiones</button>
            </div>

            <div class="input-group">
                <label for="combustible-total">üíß Combustible Disponible (litros):</label>
                <input type="number" id="combustible-total" value="1500" min="0" placeholder="Ingrese la cantidad de combustible">
            </div>

            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filtrarCamiones('todos')">
                    Todos (<span id="count-todos">0</span>)
                </button>
                <button class="filter-btn" onclick="filtrarCamiones('available')">
                    Disponibles (<span id="count-available">0</span>)
                </button>
                <button class="filter-btn" onclick="filtrarCamiones('in_transit')">
                    En Tr√°nsito (<span id="count-transit">0</span>)
                </button>
                <button class="filter-btn" onclick="filtrarCamiones('bajo-combustible')">
                    Bajo Combustible (<span id="count-bajo">0</span>)
                </button>
            </div>

            <div class="selection-summary" id="summary" style="display: none;">
                <div class="summary-item">
                    <div class="summary-value" id="count-selected">0</div>
                    <div class="summary-label">Camiones Seleccionados</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="total-needed">0L</div>
                    <div class="summary-label">Combustible Necesario</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="combustible-available">0L</div>
                    <div class="summary-label">Combustible Disponible</div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="distribuirCombustible()" id="btn-distribuir" disabled>
                    ‚ö° Distribuir Combustible
                </button>
                <button class="btn" onclick="seleccionarTodos()">
                    ‚úÖ Seleccionar Todos
                </button>
                <button class="btn btn-clear" onclick="limpiarSeleccion()">
                    ‚ùå Limpiar Selecci√≥n
                </button>
            </div>
        </div>

        <!-- Lista de Camiones -->
        <div id="trucks-container">
            <div class="loading">‚è≥ Cargando camiones...</div>
        </div>

        <!-- Resultados -->
        <div id="results" class="results"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api/greedy';
        let todosLosCamiones = [];
        let camionesSeleccionados = new Set();
        let filtroActual = 'todos';

        // Cargar camiones al iniciar
        window.onload = () => {
            cargarCamiones();
        };

        async function cargarCamiones() {
            const container = document.getElementById('trucks-container');
            container.innerHTML = '<div class="loading">‚è≥ Cargando camiones desde Neo4j...</div>';

            try {
                const response = await fetch(`${API_BASE}/camiones`);
                const data = await response.json();
                todosLosCamiones = data.camiones;
                
                actualizarContadores();
                mostrarCamiones(todosLosCamiones);
            } catch (error) {
                container.innerHTML = `<div class="error-message">‚ùå Error al cargar camiones: ${error.message}</div>`;
            }
        }

        function mostrarCamiones(camiones) {
            const container = document.getElementById('trucks-container');
            
            if (!camiones || camiones.length === 0) {
                container.innerHTML = '<div class="no-trucks">No hay camiones disponibles</div>';
                return;
            }

            let html = '<div class="trucks-grid">';
            
            camiones.forEach(camion => {
                const selected = camionesSeleccionados.has(camion.id);
                const porcentaje = camion.fuelPercentage || 0;
                const fuelClass = getFuelClass(porcentaje);
                const statusClass = getStatusClass(camion.status);
                
                html += `
                    <div class="truck-card ${selected ? 'selected' : ''}" 
                         id="card-${camion.id}"
                         onclick="toggleSelection('${camion.id}')">
                        <input type="checkbox" 
                               class="truck-checkbox" 
                               id="check-${camion.id}"
                               ${selected ? 'checked' : ''}
                               onclick="event.stopPropagation(); toggleSelection('${camion.id}')">
                        
                        <div class="truck-header">
                            <div class="truck-id">${camion.id}</div>
                        </div>
                        <div class="truck-plate">${camion.licensePlate}</div>
                        
                        <div class="truck-info">
                            <span>üíß Combustible:</span>
                            <strong>${camion.currentFuel}L / ${camion.fuelCapacity}L</strong>
                        </div>
                        
                        <div class="truck-info">
                            <span>üì¶ Capacidad:</span>
                            <strong>${(camion.capacity / 1000).toFixed(1)}t</strong>
                        </div>
                        
                        <div class="truck-info">
                            <span>üîß Necesita:</span>
                            <strong style="color: #ff6b6b;">${camion.fuelNeeded || 0}L</strong>
                        </div>
                        
                        <div class="progress-bar">
                            <div class="progress-fill ${fuelClass}" style="width: ${porcentaje}%">
                                ${porcentaje.toFixed(1)}%
                            </div>
                        </div>
                        
                        <div class="badge badge-${statusClass}">
                            ${getStatusText(camion.status)}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function toggleSelection(truckId) {
            if (camionesSeleccionados.has(truckId)) {
                camionesSeleccionados.delete(truckId);
            } else {
                camionesSeleccionados.add(truckId);
            }
            
            actualizarInterfaz();
        }

        function seleccionarTodos() {
            const camionesVisibles = filtrarCamionesPorFiltro(todosLosCamiones, filtroActual);
            camionesVisibles.forEach(c => camionesSeleccionados.add(c.id));
            actualizarInterfaz();
        }

        function limpiarSeleccion() {
            camionesSeleccionados.clear();
            actualizarInterfaz();
        }

        function actualizarInterfaz() {
            // Actualizar tarjetas
            todosLosCamiones.forEach(camion => {
                const card = document.getElementById(`card-${camion.id}`);
                const check = document.getElementById(`check-${camion.id}`);
                
                if (card && check) {
                    if (camionesSeleccionados.has(camion.id)) {
                        card.classList.add('selected');
                        check.checked = true;
                    } else {
                        card.classList.remove('selected');
                        check.checked = false;
                    }
                }
            });

            // Actualizar resumen
            actualizarResumen();
        }

        function actualizarResumen() {
            const summary = document.getElementById('summary');
            const btnDistribuir = document.getElementById('btn-distribuir');
            const count = camionesSeleccionados.size;
            
            if (count === 0) {
                summary.style.display = 'none';
                btnDistribuir.disabled = true;
                return;
            }

            summary.style.display = 'flex';
            btnDistribuir.disabled = false;

            const combustibleTotal = parseInt(document.getElementById('combustible-total').value) || 0;
            let combustibleNecesario = 0;

            camionesSeleccionados.forEach(id => {
                const camion = todosLosCamiones.find(c => c.id === id);
                if (camion) {
                    combustibleNecesario += camion.fuelNeeded || 0;
                }
            });

            document.getElementById('count-selected').textContent = count;
            document.getElementById('total-needed').textContent = combustibleNecesario + 'L';
            document.getElementById('combustible-available').textContent = combustibleTotal + 'L';
        }

        function actualizarContadores() {
            const available = todosLosCamiones.filter(c => c.status === 'AVAILABLE').length;
            const transit = todosLosCamiones.filter(c => c.status === 'IN_TRANSIT').length;
            const bajoCombustible = todosLosCamiones.filter(c => (c.fuelPercentage || 0) < 30).length;

            document.getElementById('count-todos').textContent = todosLosCamiones.length;
            document.getElementById('count-available').textContent = available;
            document.getElementById('count-transit').textContent = transit;
            document.getElementById('count-bajo').textContent = bajoCombustible;
        }

        function filtrarCamiones(filtro) {
            filtroActual = filtro;
            
            // Actualizar botones activos
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            const camionsFiltrados = filtrarCamionesPorFiltro(todosLosCamiones, filtro);
            mostrarCamiones(camionsFiltrados);
        }

        function filtrarCamionesPorFiltro(camiones, filtro) {
            switch(filtro) {
                case 'available':
                    return camiones.filter(c => c.status === 'AVAILABLE');
                case 'in_transit':
                    return camiones.filter(c => c.status === 'IN_TRANSIT');
                case 'bajo-combustible':
                    return camiones.filter(c => (c.fuelPercentage || 0) < 30);
                default:
                    return camiones;
            }
        }

        async function distribuirCombustible() {
            if (camionesSeleccionados.size === 0) {
                alert('‚ö†Ô∏è Por favor selecciona al menos un cami√≥n');
                return;
            }

            const combustible = parseInt(document.getElementById('combustible-total').value);
            if (!combustible || combustible <= 0) {
                alert('‚ö†Ô∏è Por favor ingresa una cantidad v√°lida de combustible');
                return;
            }

            const resultDiv = document.getElementById('results');
            resultDiv.innerHTML = '<div class="loading">‚è≥ Procesando distribuci√≥n...</div>';
            resultDiv.classList.add('show');

            try {
                const response = await fetch(`${API_BASE}/distribuir-combustible-personalizado`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        truckIds: Array.from(camionesSeleccionados),
                        combustibleDisponible: combustible
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    resultDiv.innerHTML = `<div class="error-message">‚ùå ${data.error}</div>`;
                    return;
                }

                mostrarResultados(data);
            } catch (error) {
                resultDiv.innerHTML = `<div class="error-message">‚ùå Error: ${error.message}</div>`;
            }
        }

        function mostrarResultados(data) {
            const resultDiv = document.getElementById('results');
            
            let html = '<div class="success-message">‚úÖ Distribuci√≥n completada exitosamente</div>';
            html += '<h2 style="color: #667eea; margin: 20px 0;">üìä Resultados de la Distribuci√≥n</h2>';
            
            // Estad√≠sticas
            html += '<div class="stats-grid">';
            html += `<div class="stat-card">
                <div class="stat-label">Combustible Disponible</div>
                <div class="stat-value">${data.combustibleDisponible}L</div>
            </div>`;
            html += `<div class="stat-card">
                <div class="stat-label">Combustible Asignado</div>
                <div class="stat-value" style="color: #00C851;">${data.combustibleAsignado}L</div>
            </div>`;
            html += `<div class="stat-card">
                <div class="stat-label">Combustible Restante</div>
                <div class="stat-value" style="color: #ff6b6b;">${data.combustibleRestante}L</div>
            </div>`;
            html += `<div class="stat-card">
                <div class="stat-label">Camiones Llenos</div>
                <div class="stat-value">${data.camionesLlenos}</div>
            </div>`;
            html += '</div>';

            // Detalle de camiones
            html += '<h3 style="margin-top: 30px; color: #667eea;">Detalle por Cami√≥n:</h3>';
            html += '<div class="trucks-grid">';
            
            data.camionesDetalle.forEach(camion => {
                const porcentaje = camion.porcentajeFinal.toFixed(1);
                const fuelClass = getFuelClass(porcentaje);
                html += `
                    <div class="truck-card selected">
                        <div class="truck-header">
                            <div class="truck-id">${camion.truckId}</div>
                            <div class="truck-plate">${camion.licensePlate}</div>
                        </div>
                        <div class="truck-info">
                            <span>Inicial:</span>
                            <strong>${camion.combustibleActual}L</strong>
                        </div>
                        <div class="truck-info">
                            <span>Necesitaba:</span>
                            <strong>${camion.necesidad}L</strong>
                        </div>
                        <div class="truck-info">
                            <span>Asignado:</span>
                            <strong style="color: #00C851;">+${camion.combustibleAsignado}L</strong>
                        </div>
                        <div class="truck-info">
                            <span>Final:</span>
                            <strong>${camion.combustibleFinal}L / ${camion.capacidadTotal}L</strong>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${fuelClass}" style="width: ${porcentaje}%">
                                ${porcentaje}%
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            resultDiv.innerHTML = html;
        }

        function getFuelClass(percentage) {
            if (percentage >= 90) return 'fuel-full';
            if (percentage >= 60) return 'fuel-high';
            if (percentage >= 30) return 'fuel-medium';
            return 'fuel-low';
        }

        function getStatusClass(status) {
            switch(status) {
                case 'AVAILABLE': return 'available';
                case 'IN_TRANSIT': return 'transit';
                case 'MAINTENANCE': return 'maintenance';
                default: return 'available';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'AVAILABLE': return '‚úÖ Disponible';
                case 'IN_TRANSIT': return 'üöö En Tr√°nsito';
                case 'MAINTENANCE': return 'üîß Mantenimiento';
                default: return status;
            }
        }

        // Actualizar resumen cuando cambie el combustible
        document.getElementById('combustible-total').addEventListener('input', actualizarResumen);
    </script>
</body>
</html>

